---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const pageSize = 10;

	const posts = (await getCollection('blog'))
		.filter((p) => p.data.lang === 'zh')
		.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

	const totalPages = Math.max(1, Math.ceil(posts.length / pageSize));

	return Array.from({ length: Math.max(0, totalPages - 1) }, (_, idx) => {
		const pageNumber = idx + 2;
		return {
			params: { page: String(pageNumber) },
			props: { totalPages },
		};
	});
}

const pageNumber = Number(Astro.params.page);
const { totalPages } = Astro.props as { totalPages: number };

const pageSize = 10;

const allPosts = (await getCollection('blog'))
	.filter((p) => p.data.lang === 'zh')
	.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const start = (pageNumber - 1) * pageSize;
const pagePosts = allPosts.slice(start, start + pageSize);

const prevHref = pageNumber <= 2 ? '/blog/' : `/blog/page/${pageNumber - 1}/`;
const nextHref = pageNumber < totalPages ? `/blog/page/${pageNumber + 1}/` : null;
---

<BaseLayout title="Blog" description="测试自动化与工程实践" locale="zh">
	<h1 class="text-3xl font-semibold tracking-tight">Blog</h1>
	<p class="mt-3 text-slate-700 dark:text-slate-300">以中文为主（暂时）。英文内容会逐步补充。</p>

	<section class="mt-10 grid gap-3">
		{pagePosts.map((post) => (
			<a class="rounded-2xl bg-white p-5 shadow-sm shadow-slate-200/70 transition hover:bg-slate-50 hover:shadow-md dark:bg-slate-900/30 dark:shadow-black/20 dark:hover:bg-slate-900/40" href={`/blog/${post.slug}/`}>
				<h2 class="text-base font-semibold">{post.data.title}</h2>
				{post.data.description ? <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">{post.data.description}</p> : null}
				<p class="mt-3 text-xs text-slate-500 dark:text-slate-400">{post.data.pubDate.toISOString().slice(0, 10)}</p>
			</a>
		))}
	</section>

	<nav class="mt-10 flex flex-wrap items-center justify-between gap-4">
		<p class="text-sm text-slate-600 dark:text-slate-400">第 {pageNumber} / {totalPages} 页</p>
		<div class="flex items-center gap-3">
			<a class="text-sm text-slate-600 hover:text-slate-950 dark:text-slate-400 dark:hover:text-slate-100" href={prevHref}>
				← 上一页
			</a>
			{nextHref ? (
				<a class="text-sm text-slate-600 hover:text-slate-950 dark:text-slate-400 dark:hover:text-slate-100" href={nextHref}>
					下一页 →
				</a>
			) : null}
		</div>
	</nav>
</BaseLayout>